---
export interface Props {
  lang: 'sr' | 'en';
}

const { lang } = Astro.props;

let teams: any[] = [];
let clubLogos: Record<string, string> = {};
let fetchError = false;
let nextGameday = '';
let nextGroup = '';

try {
  const schedulesRes = await fetch('https://api-live.euroleague.net/v1/schedules?seasonCode=e2025');
  const xml = await schedulesRes.text();

  const itemRegex = /<item>(.*?)<\/item>/g;
  const fixtures = [];
  let match;
  while ((match = itemRegex.exec(xml)) !== null) {
    const itemXml = match[1];
    const getTag = (tag: string) => {
      const tagMatch = itemXml.match(new RegExp(`<${tag}>(.*?)<\/${tag}>`));
      return tagMatch ? tagMatch[1] : '';
    };
    fixtures.push({
      gameday: getTag('gameday'),
      date: getTag('date'),
      group: getTag('group'),
    });
  }

  if (fixtures.length > 0) {
    const today = new Date();
    for (const fixture of fixtures) {
      const fixtureDate = new Date(fixture.date);
      if (fixtureDate >= today) {
        nextGameday = fixture.gameday;
        nextGroup = fixture.group;
        break;
      }
    }
    if (nextGameday) {
      const gamedayNumber = parseInt(nextGameday);
      if (!isNaN(gamedayNumber) && gamedayNumber > 1) {
        nextGameday = String(gamedayNumber - 1);
      }
    }
  }
} catch (e) {}

try {
  const response = await fetch('https://api-live.euroleague.net/v1/standings?seasonCode=E2025');
  if (response.ok) {
    const contentType = response.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
      const data = await response.json();
      teams = data?.standings || data || [];
    } else if (contentType.includes('xml') || contentType.includes('text/xml')) {
      const xmlText = await response.text();
      const teamRegex = /<team>([\s\S]*?)<\/team>/g;
      const teamsArr = [];
      let match;
      while ((match = teamRegex.exec(xmlText)) !== null) {
        const teamBlock = match[1];
        const getTag = (tag: string) => {
          const res = teamBlock.match(new RegExp(`<${tag}>(.*?)<\/${tag}>`));
          return res ? res[1] : '';
        };
        teamsArr.push({
          teamName: getTag('name'),
          wins: getTag('wins'),
          losses: getTag('losses'),
          pointsFor: getTag('ptsfavour'),
          ranking: getTag('ranking'),
          totalgames: getTag('totalgames'),
          pointsAgainst: getTag('ptsagainst'),
          difference: getTag('difference'),
          code: getTag('code'),
        });
      }
      teams = teamsArr;
    } else {
      fetchError = true;
    }
    const clubsRes = await fetch('https://api-live.euroleague.net/v2/clubs');
    if (clubsRes.ok) {
      const clubsData = await clubsRes.json();
      if (clubsData?.data) {
        for (const club of clubsData.data) {
          if (club.code && club.images && club.images.crest) {
            clubLogos[club.code] = club.images.crest;
          }
        }
      }
    }
  } else {
    fetchError = true;
  }
} catch (e) {
  fetchError = true;
}
---

<section class="table">
  <div class="table__container">
    <h2 class="table__title rw-36-600">
      {
        lang === 'en'
          ? nextGameday
            ? `Standings after Round ${nextGameday}`
            : 'Euroleague Standings'
          : nextGameday
            ? `Stanje na tabeli posle ${nextGameday} kola`
            : 'Tabela Evrolige'
      }
    </h2>
    {
      fetchError ? (
        <p style="color: red;">Greška pri preuzimanju tabele. Proveri API ili pokušaj kasnije.</p>
      ) : (
        <div class="table__wrapper">
          <table class="table__standings rw-24-500">
            <thead>
              <tr>
                <th>
                  <img src="/images/euroleague-logo.webp" alt="Euroleague logo" />
                </th>
                <th>{lang === 'en' ? 'Team' : 'Tim'}</th>
                <th>
                  <>
                    <span class="th-full">{lang === 'en' ? 'Wins' : 'Pobede'}</span>
                    <span class="th-short">W</span>
                  </>
                </th>
                <th>
                  <>
                    <span class="th-full">{lang === 'en' ? 'Losses' : 'Porazi'}</span>
                    <span class="th-short">L</span>
                  </>
                </th>
                <th>
                  <>
                    <span class="th-full">{lang === 'en' ? 'Diff' : 'Razlika'}</span>
                    <span class="th-short">{lang === 'en' ? 'D' : 'R'}</span>
                  </>
                </th>
              </tr>
            </thead>
            <tbody>
              {teams.map((team: any, idx: number) => (
                <tr>
                  <td
                    class={
                      idx < 6
                        ? 'table__number table__number--top6'
                        : idx < 10
                          ? 'table__number table__number--top10'
                          : 'table__number'
                    }
                    data-label={Astro.props.lang === 'en' ? 'Position' : 'Pozicija'}
                  >
                    {idx + 1}
                  </td>
                  <td data-label={Astro.props.lang === 'en' ? 'Team' : 'Tim'}>
                    {clubLogos[team.code] ? (
                      <img
                        src={clubLogos[team.code]}
                        alt={team.teamName + ' logo'}
                        class="table__logo"
                      />
                    ) : null}
                    <span class="team-name">{team.teamName}</span>
                  </td>
                  <td data-label={Astro.props.lang === 'en' ? 'Wins' : 'Pobede'}>{team.wins}</td>
                  <td data-label={Astro.props.lang === 'en' ? 'Losses' : 'Porazi'}>
                    {team.losses}
                  </td>
                  <td data-label={Astro.props.lang === 'en' ? 'Diff' : 'Razlika'}>
                    {team.difference > 0 ? `+${team.difference}` : team.difference}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>
</section>
