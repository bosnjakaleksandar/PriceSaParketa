---
let teams: any[] = [];
let clubLogos: Record<string, string> = {};
let fetchError = false;
try {
  const response = await fetch('https://api-live.euroleague.net/v1/standings?seasonCode=E2025');
  if (response.ok) {
    const contentType = response.headers.get('content-type') || '';
    if (contentType.includes('application/json')) {
      const data = await response.json();
      teams = data?.standings || data || [];
    } else if (contentType.includes('xml') || contentType.includes('text/xml')) {
      const xmlText = await response.text();
      const teamRegex = /<team>([\s\S]*?)<\/team>/g;
      const teamsArr = [];
      let match;
      while ((match = teamRegex.exec(xmlText)) !== null) {
        const teamBlock = match[1];
        const getTag = (tag: string) => {
          const res = teamBlock.match(new RegExp(`<${tag}>(.*?)<\/${tag}>`));
          return res ? res[1] : '';
        };
        teamsArr.push({
          teamName: getTag('name'),
          wins: getTag('wins'),
          losses: getTag('losses'),
          pointsFor: getTag('ptsfavour'),
          ranking: getTag('ranking'),
          totalgames: getTag('totalgames'),
          pointsAgainst: getTag('ptsagainst'),
          difference: getTag('difference'),
          code: getTag('code'),
        });
      }
      teams = teamsArr;
    } else {
      fetchError = true;
    }
    const clubsRes = await fetch('https://api-live.euroleague.net/v2/clubs');
    if (clubsRes.ok) {
      const clubsData = await clubsRes.json();
      if (clubsData?.data) {
        for (const club of clubsData.data) {
          if (club.code && club.images && club.images.crest) {
            clubLogos[club.code] = club.images.crest;
          }
        }
      }
    }
  } else {
    fetchError = true;
  }
} catch (e) {
  fetchError = true;
}
---

<section class="table">
  <div class="table__container">
    {
      fetchError ? (
        <p style="color: red;">Greška pri preuzimanju tabele. Proveri API ili pokušaj kasnije.</p>
      ) : (
        <div class="table__wrapper">
          <table class="table__standings rw-24-500">
            <thead>
              <tr>
                <th>
                  <img src="/images/euroleague-logo.webp" />
                </th>
                <th>Tim</th>
                <th>Pobede</th>
                <th>Porazi</th>
                <th>Poeni</th>
              </tr>
            </thead>
            <tbody>
              {teams.map((team: any, idx: number) => (
                <tr>
                  <td
                    class={
                      idx < 6
                        ? 'table__number table__number--top6'
                        : idx < 10
                          ? 'table__number table__number--top10'
                          : 'table__number'
                    }
                    data-label="Pozicija"
                  >
                    {idx + 1}
                  </td>
                  <td data-label="Tim">
                    {clubLogos[team.code] ? (
                      <img
                        src={clubLogos[team.code]}
                        alt={team.teamName + ' logo'}
                        class="table__logo"
                      />
                    ) : null}
                    <span>{team.teamName}</span>
                  </td>
                  <td data-label="Pobede">{team.wins}</td>
                  <td data-label="Porazi">{team.losses}</td>
                  <td data-label="Poeni">{team.pointsFor}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )
    }
  </div>
</section>
